# 完整数据库迁移指南

## ⚠️ 重要提示

如果你看到以下错误之一：
- **"Could not find the 'user_id' column of 'items' in the schema cache"**
- **"null value in column 'location' of relation 'items' violates not-null constraint"**

这说明数据库表需要迁移。请按照以下步骤执行迁移。

## 🚀 快速修复（3 步完成）

### 步骤 1: 打开 Supabase SQL Editor

1. 访问 https://app.supabase.com
2. 选择你的项目
3. 点击左侧菜单的 **"SQL Editor"**
4. 点击 **"New query"** 按钮

### 步骤 2: 复制并执行以下 SQL

**一次性执行所有迁移**（推荐）：

```sql
-- ============================================
-- 完整数据库迁移脚本
-- 一次性执行所有必需的更改
-- ============================================

-- 1. 添加 owner_name 列（如果不存在）
ALTER TABLE items ADD COLUMN IF NOT EXISTS owner_name TEXT;

-- 2. 更新所有现有商品的 owner_name
UPDATE items SET owner_name = 'CircuRent' WHERE owner_name IS NULL;

-- 3. 添加 user_id 列（如果不存在）
ALTER TABLE items ADD COLUMN IF NOT EXISTS user_id TEXT;

-- 4. 修复 location 列的约束（允许 NULL 或设置默认值）
-- 如果 location 列是 NOT NULL，需要修改为允许 NULL 或设置默认值
ALTER TABLE items ALTER COLUMN location DROP NOT NULL;

-- 5. 为现有记录设置 location 默认值（如果为 NULL）
UPDATE items SET location = 'CircuRent' WHERE location IS NULL;

-- 6. 创建索引以提高查询性能
CREATE INDEX IF NOT EXISTS idx_items_user_id ON items(user_id);
CREATE INDEX IF NOT EXISTS idx_items_owner_name ON items(owner_name);

-- 7. 验证：查看表结构（可选）
-- SELECT column_name, data_type, is_nullable
-- FROM information_schema.columns 
-- WHERE table_name = 'items'
-- ORDER BY ordinal_position;
```

### 步骤 3: 验证迁移

1. **在 Supabase Dashboard 中检查**
   - 点击左侧菜单的 **"Table Editor"**
   - 打开 `items` 表
   - 确认看到以下列：
     - ✅ `owner_name` (TEXT)
     - ✅ `user_id` (TEXT)

2. **测试功能**
   - 刷新应用页面
   - 尝试添加一个新物品
   - 应该不再出现错误

## 📋 分步执行（如果需要）

如果你更喜欢分步执行，可以按顺序执行以下 SQL：

### 迁移 1: 添加 owner_name 列

```sql
-- 添加 owner_name 列
ALTER TABLE items ADD COLUMN IF NOT EXISTS owner_name TEXT;

-- 更新现有数据
UPDATE items SET owner_name = 'CircuRent' WHERE owner_name IS NULL;
```

### 迁移 2: 添加 user_id 列

```sql
-- 添加 user_id 列
ALTER TABLE items ADD COLUMN IF NOT EXISTS user_id TEXT;

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_items_user_id ON items(user_id);
```

### 迁移 3: 修复 location 列约束

```sql
-- 如果 location 列是 NOT NULL，修改为允许 NULL
ALTER TABLE items ALTER COLUMN location DROP NOT NULL;

-- 为现有记录设置默认值
UPDATE items SET location = 'CircuRent' WHERE location IS NULL;
```

## ✅ 验证清单

执行 SQL 后，确认以下内容：

- [ ] `items` 表有 `owner_name` 列
- [ ] `items` 表有 `user_id` 列
- [ ] 所有现有商品的 `owner_name` 都是 `CircuRent`
- [ ] 索引已创建（`idx_items_user_id`）
- [ ] 应用可以正常添加新物品

## 🐛 常见问题

### 1. "column already exists" 错误

**原因**：列已经存在

**解决**：这是正常的，`IF NOT EXISTS` 会跳过已存在的列。可以继续执行其他 SQL。

### 2. "permission denied" 错误

**原因**：权限不足

**解决**：
- 确认你使用的是项目所有者账户
- 或者使用 Service Role Key（在 API 设置中）

### 3. 迁移后仍然报错

**原因**：Supabase 缓存未更新

**解决**：
1. 等待几秒钟让缓存更新
2. 刷新应用页面
3. 如果还是不行，检查 SQL 是否真的执行成功

### 4. "null value in column 'location' violates not-null constraint" 错误

**原因**：`location` 列被设置为 NOT NULL，但代码没有提供该值

**解决**：执行以下 SQL 修改约束：
```sql
ALTER TABLE items ALTER COLUMN location DROP NOT NULL;
```

### 5. 如何检查表结构？

执行以下 SQL 查看表结构：

```sql
SELECT 
  column_name, 
  data_type, 
  is_nullable,
  column_default
FROM information_schema.columns 
WHERE table_name = 'items'
ORDER BY ordinal_position;
```

## 📝 SQL 说明

- **`ADD COLUMN IF NOT EXISTS`**：如果列已存在则不会报错，安全执行
- **`UPDATE ... WHERE ... IS NULL`**：只更新空值，不会覆盖已有数据
- **`CREATE INDEX IF NOT EXISTS`**：如果索引已存在则不会报错

## 🎯 执行后

迁移完成后：

1. ✅ 用户可以正常添加物品
2. ✅ 物品会自动关联到创建者（`user_id`）
3. ✅ 物品会显示所有者名称（`owner_name`）
4. ✅ 系统默认商品（CircuRent）的 `user_id` 为 NULL（正常）

## 📚 相关文件

- `supabase_add_user_id.sql` - 添加 user_id 列的 SQL
- `supabase_migration.sql` - 添加 owner_name 列的 SQL
- `快速迁移指南.md` - owner_name 迁移指南

---

**提示**：如果遇到任何问题，请检查 Supabase Dashboard 中的错误信息，或查看应用的控制台日志。

