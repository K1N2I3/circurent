# 用户头像功能说明

## ✅ 已完成的功能

### 1. 个人资料页面编辑功能
- ✅ 可以上传和更改头像
- ✅ 可以编辑邮件地址
- ✅ 头像自动上传到 Supabase Storage
- ✅ 实时预览头像

### 2. 物品详情页面
- ✅ 在 Owner（所有者）部分显示用户头像
- ✅ 如果用户有自定义头像，显示头像；否则显示首字母头像

### 3. 导航栏
- ✅ 用户菜单显示用户头像
- ✅ 支持自定义头像和默认首字母头像

## 🔧 配置步骤

### 步骤 1: 数据库迁移

在 Supabase SQL Editor 中执行：

```sql
-- 添加 avatar_url 列
ALTER TABLE users ADD COLUMN IF NOT EXISTS avatar_url TEXT;
```

或执行 `supabase_add_avatar_url.sql` 文件。

### 步骤 2: 创建 Supabase Storage Bucket（用于存储头像）

1. **登录 Supabase Dashboard**
   - 访问 https://app.supabase.com
   - 选择你的项目

2. **创建 Storage Bucket**
   - 点击左侧菜单的 "Storage"
   - 点击 "New bucket"
   - **Name**: `user-avatars`（必须使用这个名称）
   - **Public bucket**: ✅ **勾选**（重要！）
   - 点击 "Create bucket"

3. **设置权限（可选）**
   - 如果 bucket 设置为公开，通常不需要额外配置
   - 如果需要更精细的控制，可以添加策略

### 步骤 3: 验证功能

1. **登录账户**
2. **进入个人资料页面**（点击用户头像 → Profile）
3. **更改头像**：
   - 点击头像右下角的相机图标
   - 选择图片文件
   - 点击 "Save" 保存
4. **更改邮件**：
   - 点击邮件地址旁边的 "Edit" 按钮
   - 输入新邮件地址
   - 点击 "Save" 保存
5. **查看物品详情**：
   - 进入任何物品详情页面
   - 在 Owner 部分应该能看到用户头像

## 📝 功能特点

### 头像功能
- **自动上传**：头像会自动上传到 Supabase Storage
- **实时预览**：选择图片后立即显示预览
- **回退机制**：如果上传失败，会使用 base64 格式存储
- **默认头像**：如果没有自定义头像，显示用户名字首字母

### 邮件编辑
- **验证**：检查邮件格式和是否已被使用
- **实时更新**：保存后立即更新显示

### 物品详情页
- **自动获取**：自动获取物品所有者的头像信息
- **优雅降级**：如果无法获取头像，显示默认首字母头像

## 🎨 UI 设计

### 个人资料页面
- 头像显示在页面顶部，带有编辑按钮
- 邮件地址可以内联编辑
- 所有更改都有保存和取消按钮

### 物品详情页面
- Owner 卡片显示用户头像和名称
- 头像和名称并排显示，布局清晰

## ⚠️ 注意事项

1. **Storage Bucket 名称**
   - 必须使用 `user-avatars` 作为 bucket 名称
   - 必须设置为公开（Public bucket）

2. **图片格式**
   - 支持所有常见图片格式（JPEG, PNG, GIF, WebP 等）
   - 建议使用 JPEG 或 PNG 格式

3. **图片大小**
   - 建议上传小于 2MB 的图片
   - 系统会自动处理 base64 编码

4. **邮件验证**
   - 新邮件不能为空
   - 不能与其他用户的邮件重复
   - 系统会验证邮件格式

## 🐛 常见问题

### 1. 头像上传失败

**原因**：Storage bucket 未创建或未设置为公开

**解决**：
- 确认已创建 `user-avatars` bucket
- 确认 bucket 设置为 "Public bucket"
- 检查 `SUPABASE_SERVICE_ROLE_KEY` 环境变量

### 2. 头像不显示

**原因**：图片 URL 无效或 bucket 权限问题

**解决**：
- 检查图片 URL 是否正确
- 确认 bucket 是公开的
- 在浏览器中直接访问图片 URL 测试

### 3. 邮件更新失败

**原因**：邮件已被使用或格式不正确

**解决**：
- 检查错误提示信息
- 确认新邮件格式正确
- 确认新邮件未被其他用户使用

## 📚 相关文件

- `app/profile/page.tsx` - 个人资料页面
- `app/api/auth/user/update/route.ts` - 更新用户信息 API
- `app/components/UserAvatar.tsx` - 头像组件
- `app/items/[id]/page.tsx` - 物品详情页面
- `supabase_add_avatar_url.sql` - 数据库迁移 SQL

---

**提示**：配置完成后，用户可以自由上传和更改头像，头像会在整个应用中显示！

